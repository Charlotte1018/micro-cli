# Micro-CLI 配置文件说明文档

## 概述

Micro-CLI 是一个多项目发版工具，通过配置文件来管理项目的构建和部署流程。主要包含两个核心配置文件：

- `config/project.json` - 项目配置
- `config/target.json` - 部署目标配置

## 配置文件详解

### 1. project.json - 项目配置文件

该文件定义了需要构建和部署的项目信息，包括项目的 Git 仓库地址、构建目录、部署配置等。

#### 文件结构

```json
{
  "项目名称": {
    "gitPath": "Git仓库地址",
    "buildDir": "构建输出目录",
    "description": "项目描述",
    "targetDir": "默认目标目录",
    "gitDir": "本地项目目录路径",
    "targetConfigs": [
      {
        "name": "环境名称",
        "branch": "构建分支",
        "buildCommand": "构建命令",
        "targetBranch": "部署目标分支",
        "target": "部署目标仓库",
        "targetDir": "部署目录"
      }
    ]
  }
}
```

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `gitPath` | String | ✅ | 项目的 Git 仓库地址（SSH 格式） |
| `buildDir` | String | ✅ | 项目构建后的输出目录名称 |
| `description` | String | ❌ | 项目的描述信息 |
| `targetDir` | String | ✅ | 默认的部署目标目录名称 |
| `gitDir` | String | ✅ | 项目在本地的工作目录绝对路径 |
| `targetConfigs` | Array | ✅ | 不同环境的部署配置数组 |

#### targetConfigs 配置说明

每个环境配置包含以下字段：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | String | ✅ | 环境名称（如：测试、预发、生产） |
| `branch` | String | ✅ | 构建时使用的分支名称 |
| `buildCommand` | String | ✅ | 构建命令（如：npm run build） |
| `targetBranch` | String | ✅ | 部署到目标仓库的分支名称 |
| `target` | String | ✅ | 目标仓库的标识符（对应 target.json 中的 key） |
| `targetDir` | String | ❌ | 部署目录名称（可选，默认使用项目级别的 targetDir） |

### 2. target.json - 部署目标配置文件

该文件定义了部署目标仓库的信息，包括本地路径和描述。

#### 文件结构

```json
{
  "目标仓库标识": {
    "path": "本地仓库绝对路径",
    "description": "目标仓库描述"
  }
}
```

> 目标仓库标识，确保和项目名称保持一致

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | String | ✅ | 目标仓库在本地文件系统中的绝对路径 |
| `description` | String | ❌ | 目标仓库的描述信息 |


## 工作流程

1. **项目克隆/更新**：根据 `project.json` 中的 `gitPath` 和 `gitDir` 克隆或更新项目
2. **分支切换**：切换到 `targetConfigs` 中指定环境的分支
3. **项目构建**：执行 `buildCommand` 进行项目构建
4. **文件复制**：将构建产物从 `buildDir` 复制到目标仓库的指定目录
5. **代码提交**：在目标仓库中提交更改并推送到远程分支

## 配置最佳实践

### 1. 项目配置建议

- **gitPath**：使用 SSH 格式的 Git 地址，确保有访问权限
- **gitDir**：使用绝对路径，避免相对路径可能带来的问题
- **buildDir**：确保与项目的实际构建输出目录一致
- **targetConfigs**：为每个环境配置独立的构建命令和分支

### 2. 目标配置建议

- **path**：确保路径存在且有写入权限
- **description**：提供清晰的描述，便于识别不同目标仓库的用途

### 3. 环境命名规范

建议使用以下环境标识：
- `test` - 测试环境
- `pre` - 预发环境  
- `master` - 生产环境

## 注意事项

1. **权限要求**：确保对 Git 仓库和本地目录有相应的读写权限
2. **路径格式**：所有路径建议使用绝对路径，避免相对路径问题
3. **分支管理**：确保配置的分支在远程仓库中存在
4. **构建命令**：确保构建命令在项目根目录下可以正常执行
5. **目录结构**：确保目标目录结构符合部署要求

## 故障排除

### 常见问题

1. **Git 克隆失败**：检查网络连接和 SSH 密钥配置
2. **分支切换失败**：确认分支在远程仓库中存在
3. **构建失败**：检查构建命令和项目依赖
4. **文件复制失败**：检查目标目录权限和路径正确性
5. **Git 推送失败**：检查目标仓库的访问权限

### 调试建议

- 查看命令行输出的详细日志信息
- 检查配置文件格式是否正确（JSON 格式）
- 验证所有路径和命令的有效性
- 确保 Git 仓库状态正常，无未提交的更改
